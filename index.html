<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4caf50">
  <title>Mushroom Grow Log</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    form { margin-bottom: 20px; }
    label { display: block; margin-top: 10px; }
    input, textarea, select { width: 100%; padding: 5px; margin-top: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .tab-buttons { margin-bottom: 20px; }
    button { margin-right: 10px; }
    .hidden { display: none; }
    input[type="text"].search-bar { width: 100%; padding: 8px; margin-top: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
  <h1>Mushroom Grow Log</h1>
  
  <!-- Tab Buttons -->
  <div class="tab-buttons">
    <button onclick="showTab('daily')">Daily Data</button>
    <button onclick="showTab('harvest')">Harvest Data</button>
    <button onclick="showTab('block')">Block Info</button>
    <button onclick="showTab('settings')">Settings</button>
    <button onclick="showTab('dashboard')">Dashboard</button>

  </div>

  <!-- Daily Data -->
  <div id="daily" class="tab">
    <h2>Daily Data Entry</h2>
    <form id="dailyForm">
      <label>Date <input type="date" name="date" required></label>
      <label>Species 
        <select name="species" id="speciesDaily"></select>
      </label>
      <label>Treatment 
        <select name="treatment" id="treatmentDaily">
          <option value="4hr">4hr</option>
          <option value="8hr">8hr</option>
          <option value="12hr">12hr</option>
          <option value="No Light">No Light</option>
        </select>
      </label>
      <label>Block 
        <select name="block" id="blockDaily"></select>
      </label>
      <label>Growth (mm/day) <input type="number" step="0.1" name="growth"></label>
      <label>Temp (F) <input type="number" step="0.1" name="temp"></label>
      <label>Rel Humidity (%) <input type="number" step="0.1" name="humidity"></label>
      <label>COâ‚‚ (ppm) <input type="number" step="1" name="co2"></label>
      <label>Notes <textarea name="notes"></textarea></label>
      <label>Flush Height (mm) <input type="number" step="0.1" name="flushHeight"></label>
      <button type="submit">Save Entry</button>
    </form>

    <input type="text" id="searchDaily" class="search-bar" placeholder="Search Daily Logs..." onkeyup="filterTable('dailyTable', this.value)">
    <button onclick="exportCSV('daily')">Export Daily Data CSV</button>
    <table id="dailyTable">
      <thead>
        <tr>
          <th>Date</th><th>Species</th><th>Treatment</th><th>Block</th>
          <th>Growth</th><th>Temp</th><th>Humidity</th><th>COâ‚‚</th>
          <th>Notes</th><th>Flush Height</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Harvest Data -->
  <div id="harvest" class="tab hidden">
    <h2>Harvest Data Entry</h2>
    <form id="harvestForm">
      <label>Date <input type="date" name="date" required></label>
      <label>Species 
        <select name="species" id="speciesHarvest"></select>
      </label>
      <label>Treatment (hr)
        <select name="treatment" id="treatmentHarvest">
          <option value="4hr">4hr</option>
          <option value="8hr">8hr</option>
          <option value="12hr">12hr</option>
          <option value="No Light">No Light</option>
        </select>
      </label>
      <label>Block 
        <select name="block" id="blockHarvest"></select>
      </label>
      <label>Avg Temp (F) <input type="number" step="0.1" name="avgTemp"></label>
      <label>Avg Humidity (%) <input type="number" step="0.1" name="avgHumidity"></label>
      <label>Avg COâ‚‚ (ppm) <input type="number" step="1" name="avgCo2"></label>
      <label>Cap Diameter (mm) <input type="number" step="0.1" name="capDiameter"></label>
      <label>Stem Length (mm) <input type="number" step="0.1" name="stemLength"></label>
      <label>Flush Height (mm) <input type="number" step="0.1" name="flushHeight"></label>
      <label>Flush Width (mm) <input type="number" step="0.1" name="flushWidth"></label>
      <label>Flush Length (mm) <input type="number" step="0.1" name="flushLength"></label>
      <label>Pin-Set Date <input type="date" name="pinDate"></label>
      <label>Time-to-Fruit (days) <input type="number" name="timeToFruit"></label>
      <label>Fresh Weight/Yield (g) <input type="number" step="0.1" name="yield"></label>
      <label>Notes <textarea name="notes"></textarea></label>
      <label>
        <input type="checkbox" id="lockFields"> ðŸ”’ Lock Auto-Filled Fields
      </label>
      
      <button type="submit">Save Entry</button>
    </form>

    <input type="text" id="searchHarvest" class="search-bar" placeholder="Search Harvest Logs..." onkeyup="filterTable('harvestTable', this.value)">
    <button onclick="exportCSV('harvest')">Export Harvest Data CSV</button>
    <table id="harvestTable">
      <thead>
        <tr>
          <th>Date</th><th>Species</th><th>Treatment</th><th>Block</th>
          <th>Avg Temp</th><th>Humidity</th><th>COâ‚‚</th><th>Cap</th>
          <th>Stem</th><th>Flush H</th><th>Flush W</th><th>Flush L</th>
          <th>Pin Date</th><th>Time</th><th>Yield</th><th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Block Info -->
  <div id="block" class="tab hidden">
    <h2>Block Information</h2>
    <form id="blockForm">
      <label>Block 
        <select name="block" id="blockInfo">
          <option value="Block A">Block A</option>
          <option value="Block A-Flush2">Block A-Flush2</option>
          <option value="Block B">Block B</option>
          <option value="Block B-Flush2">Block B-Flush2</option>
          <option value="Block C">Block C</option>
          <option value="Block C-Flush2">Block C-Flush2</option>
          <option value="Block D">Block D</option>
          <option value="Block D-Flush2">Block D-Flush2</option>
        </select>
      </label>
      <label>Start Date <input type="date" name="startDate"></label>
      <label>Pin Date <input type="date" name="pinDate"></label>
      <label>Harvest Date <input type="date" name="harvestDate"></label>
      <label>Lot Number <input type="text" name="lotNumber"></label>
      <label>Generation <input type="text" name="generation"></label>
      <label>Growth Rate <input type="text" name="growthRate"></label>
      <label>Slice Type <input type="text" name="sliceType"></label>
      <label>Time Increase <input type="text" name="timeIncrease"></label>
      <button type="submit">Save Block</button>
    </form>

    <input type="text" id="searchBlock" class="search-bar" placeholder="Search Block Info..." onkeyup="filterTable('blockTable', this.value)">
    <button onclick="exportCSV('block')">Export Block Info CSV</button>
    <table id="blockTable">
      <thead>
        <tr>
          <th>Block</th><th>Start</th><th>Pin</th><th>Harvest</th>
          <th>Lot</th><th>Gen</th><th>Growth Rate</th><th>Slice Type</th><th>Time+</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Settings -->
  <div id="settings" class="tab hidden">
    <h2>Settings</h2>
    <button onclick="checkForUpdate()">ðŸ”„ Check for Updates</button>
    <button onclick="clearAllData()">ðŸ—‘ Clear All Data</button>
    <p style="margin-top:10px; color:gray; font-size:14px;">
      App Version: <span id="appVersion"></span>
    </p>
  </div>

  <!-- Update Banner -->
  <div id="updateBanner" style="
    display:none; position:fixed; bottom:0; width:100%;
    background:#4caf50; color:white; text-align:center;
    padding:10px; font-size:16px; cursor:pointer; z-index:1000;">
    ðŸ”„ New version available! Tap here to refresh.
  </div>

  <div id="dashboard" class="tab hidden">
    <h2>Quick Summary Dashboard</h2>
  
    <!-- Key Stats -->
    <div id="keyStats">
      <h3>Key Metrics</h3>
      <ul id="metricsList"></ul>
    </div>
  
    <!-- Active Blocks -->
    <div id="activeBlocks">
      <h3>Active Blocks</h3>
      <table>
        <thead>
          <tr><th>Block</th><th>Pin Date</th><th>Harvest Date</th><th>Days Since Pin</th></tr>
        </thead>
        <tbody id="activeBlocksBody"></tbody>
      </table>
    </div>
  
    <!-- Environmental Trends -->
    <div id="envTrends">
      <h3>Environmental Trends (Last 7 Days)</h3>
      <canvas id="envChart" width="400" height="200"></canvas>
    </div>
  
    <!-- Harvest Stats -->
    <div id="harvestStats">
      <h3>Harvest Stats</h3>
      <ul id="harvestSummary"></ul>
    </div>
  </div>
  

<script>
const data = { daily: [], harvest: [], block: [] };

// Tab switching
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
  document.getElementById(tab).classList.remove('hidden');
}

// Handle form submissions
function handleForm(formId, type, tableId) {
  document.getElementById(formId).addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const entry = {};
    formData.forEach((value, key) => entry[key] = value);
    data[type].push(entry);
    localStorage.setItem(type, JSON.stringify(data[type]));
    renderTable(type, tableId);
    e.target.reset();
  });
}

// Render tables
function renderTable(type, tableId) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  (JSON.parse(localStorage.getItem(type)) || []).forEach(entry => {
    const row = document.createElement('tr');
    Object.values(entry).forEach(val => {
      const cell = document.createElement('td');
      cell.textContent = val;
      row.appendChild(cell);
    });
    tbody.appendChild(row);
  });
}

// Export CSV
function exportCSV(type) {
  const rows = JSON.parse(localStorage.getItem(type)) || [];
  if (rows.length === 0) return alert('No data to export');
  const headers = Object.keys(rows[0]).join(',');
  const csv = [headers, ...rows.map(r => Object.values(r).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${type}_data.csv`;
  a.click();
}

// Search/filter
function filterTable(tableId, query) {
  const table = document.getElementById(tableId);
  const rows = table.getElementsByTagName('tr');
  query = query.toLowerCase();
  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].getElementsByTagName('td');
    let match = false;
    for (let cell of cells) {
      if (cell.textContent.toLowerCase().includes(query)) {
        match = true;
        break;
      }
    }
    rows[i].style.display = match ? '' : 'none';
  }
}

// Initialize forms/tables
['daily','harvest','block'].forEach(type => {
  renderTable(type, `${type}Table`);
  handleForm(`${type}Form`, type, `${type}Table`);
});

// Service Worker + Update Banner
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => {
      console.log('Service Worker Registered');
      navigator.serviceWorker.addEventListener('message', event => {
        if (event.data.type === 'UPDATE_AVAILABLE') {
          const banner = document.getElementById('updateBanner');
          banner.style.display = 'block';
          banner.addEventListener('click', () => window.location.reload());
        }
      });
    });
}

const APP_VERSION = 'v4';
document.getElementById('appVersion').textContent = APP_VERSION;

function checkForUpdate() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
      if (reg) reg.update().then(() => alert('Checking for updates...'));
    });
  }
}

function clearAllData() {
  if (confirm("Are you sure you want to delete all log data? This cannot be undone.")) {
    localStorage.clear();
    alert("All log data cleared.");
    location.reload();
  }
}

// Populate species dropdowns
const speciesList = [
  "Pleurotus ostreatus (Snow Oyster)",
  "Pholiota adiposa (Chestnut)",
  "Hericium erinaceus (Lion's Mane)",
  "Lentinula edodes (Shiitake)",
  "Pleurotus citrinolileatus (Golden Oyster)",
  "Pleurotus djamor (Pink Oyster)",
  "Pleurotus ostreatus (Blue Oyster)",
  "Pleurotus pulmonarius (Italian Oyster)"
];

function populateSpeciesDropdown(id) {
  const select = document.getElementById(id);
  speciesList.forEach(sp => {
    const option = document.createElement('option');
    option.value = sp;
    option.textContent = sp;
    select.appendChild(option);
  });
}

populateSpeciesDropdown('speciesDaily');
populateSpeciesDropdown('speciesHarvest');

// Auto-calculate and auto-fill Harvest fields (Pin Date, Species, Treatment, Time-to-Fruit, Averages)
document.querySelector('#harvestForm').addEventListener('input', () => {
  const pinDateInput = document.querySelector('#harvestForm [name="pinDate"]');
  const harvestDateInput = document.querySelector('#harvestForm [name="date"]').value;
  const blockValue = document.querySelector('#harvestForm [name="block"]').value;
  const speciesField = document.querySelector('#harvestForm [name="species"]');
  const treatmentField = document.querySelector('#harvestForm [name="treatment"]');
  const lockToggle = document.getElementById('lockFields');

  // Auto-fill Pin Date from Block Info
  if (blockValue) {
    const blockLogs = JSON.parse(localStorage.getItem('block')) || [];
    const blockMatch = blockLogs.find(entry => entry.block === blockValue && entry.pinDate);
    if (blockMatch && !pinDateInput.value) {
      pinDateInput.value = blockMatch.pinDate;
      flashHighlight(pinDateInput);
    }

    // Auto-fill Species & Treatment from latest Daily log for this block
    const dailyLogs = JSON.parse(localStorage.getItem('daily')) || [];
    const blockDailyLogs = dailyLogs
      .filter(entry => entry.block === blockValue)
      .sort((a, b) => new Date(b.date) - new Date(a.date));

    if (blockDailyLogs.length > 0) {
      const latest = blockDailyLogs[0];
      if (!speciesField.value) {
        speciesField.value = latest.species;
        flashHighlight(speciesField);
      }
      if (!treatmentField.value) {
        treatmentField.value = latest.treatment;
        flashHighlight(treatmentField);
      }
    }
  }

  // Calculate Time-to-Fruit & Averages
  if (pinDateInput.value && harvestDateInput && blockValue) {
    const pinDate = new Date(pinDateInput.value);
    const harvestDate = new Date(harvestDateInput);

    const diffDays = Math.round((harvestDate - pinDate) / (1000 * 60 * 60 * 24));
    const timeField = document.querySelector('#harvestForm [name="timeToFruit"]');
    timeField.value = diffDays;
    flashHighlight(timeField);

    const dailyLogs = JSON.parse(localStorage.getItem('daily')) || [];
    const filtered = dailyLogs.filter(entry => {
      return entry.block === blockValue &&
        new Date(entry.date) >= pinDate &&
        new Date(entry.date) <= harvestDate;
    });

    if (filtered.length > 0) {
      const avg = (arr, key) => arr.reduce((sum, e) => sum + parseFloat(e[key] || 0), 0) / arr.length;

      const avgTemp = document.querySelector('#harvestForm [name="avgTemp"]');
      const avgHumidity = document.querySelector('#harvestForm [name="avgHumidity"]');
      const avgCo2 = document.querySelector('#harvestForm [name="avgCo2"]');

      avgTemp.value = avg(filtered, 'temp').toFixed(1);
      avgHumidity.value = avg(filtered, 'humidity').toFixed(1);
      avgCo2.value = avg(filtered, 'co2').toFixed(0);

      flashHighlight(avgTemp);
      flashHighlight(avgHumidity);
      flashHighlight(avgCo2);
    }
  }

  // Apply Lock/Unlock state
  toggleLockFields(lockToggle.checked);
});

// Lock or unlock auto-filled fields
document.getElementById('lockFields').addEventListener('change', function() {
  toggleLockFields(this.checked);
});

function toggleLockFields(lock) {
  const fieldsToLock = [
    '#harvestForm [name="pinDate"]',
    '#harvestForm [name="species"]',
    '#harvestForm [name="treatment"]',
    '#harvestForm [name="avgTemp"]',
    '#harvestForm [name="avgHumidity"]',
    '#harvestForm [name="avgCo2"]',
    '#harvestForm [name="timeToFruit"]'
  ];

  fieldsToLock.forEach(selector => {
    const field = document.querySelector(selector);
    if (field) field.readOnly = lock;
  });
}

// Green flash highlight
function flashHighlight(element) {
  element.style.transition = "background-color 0.5s";
  element.style.backgroundColor = "#c8f7c5"; 
  setTimeout(() => {
    element.style.backgroundColor = "";
  }, 800);
}

// Load Dashboard Data on Tab Open
function loadDashboard() {
  loadKeyMetrics();
  loadActiveBlocks();
  loadEnvTrends();
  loadHarvestStats();
}

// Auto-run dashboard load when tab is opened
document.querySelector('button[onclick="showTab(\'dashboard\')"]').addEventListener('click', loadDashboard);

// ---------------- KEY METRICS ----------------
function loadKeyMetrics() {
  const blockLogs = JSON.parse(localStorage.getItem('block')) || [];
  const harvestLogs = JSON.parse(localStorage.getItem('harvest')) || [];

  const metricsList = document.getElementById('metricsList');
  metricsList.innerHTML = '';

  const totalHarvests = harvestLogs.length;
  const recentHarvest = harvestLogs.slice(-1)[0]?.yield || "N/A";
  const nextHarvestBlock = blockLogs.find(b => !b.harvestDate)?.block || "None Pending";

  metricsList.innerHTML = `
    <li><strong>Total Harvests:</strong> ${totalHarvests}</li>
    <li><strong>Most Recent Harvest Weight:</strong> ${recentHarvest} g</li>
    <li><strong>Next Harvest Block:</strong> ${nextHarvestBlock}</li>
  `;
}

// ---------------- ACTIVE BLOCKS ----------------
function loadActiveBlocks() {
  const blockLogs = JSON.parse(localStorage.getItem('block')) || [];
  const tbody = document.getElementById('activeBlocksBody');
  tbody.innerHTML = '';

  blockLogs.forEach(block => {
    if (!block.harvestDate) { // Show only active blocks
      const pinDate = block.pinDate || "N/A";
      const daysSincePin = block.pinDate ? Math.round((new Date() - new Date(block.pinDate)) / (1000 * 60 * 60 * 24)) : "-";

      const row = `<tr>
        <td>${block.block}</td>
        <td>${pinDate}</td>
        <td>${block.harvestDate || "-"}</td>
        <td>${daysSincePin}</td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    }
  });
}

// ---------------- ENVIRONMENTAL TRENDS ----------------
function loadEnvTrends() {
  const dailyLogs = JSON.parse(localStorage.getItem('daily')) || [];
  const last7 = dailyLogs.slice(-7); // last 7 entries

  const labels = last7.map(l => l.date);
  const temps = last7.map(l => parseFloat(l.temp) || 0);
  const humidity = last7.map(l => parseFloat(l.humidity) || 0);
  const co2 = last7.map(l => parseFloat(l.co2) || 0);

  const ctx = document.getElementById('envChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Temp (F)', data: temps, borderColor: 'red', fill: false },
        { label: 'Humidity (%)', data: humidity, borderColor: 'blue', fill: false },
        { label: 'COâ‚‚ (ppm)', data: co2, borderColor: 'green', fill: false }
      ]
    },
    options: { responsive: true }
  });
}

// ---------------- HARVEST STATS ----------------
function loadHarvestStats() {
  const harvestLogs = JSON.parse(localStorage.getItem('harvest')) || [];
  const summaryList = document.getElementById('harvestSummary');
  summaryList.innerHTML = '';

  if (harvestLogs.length === 0) {
    summaryList.innerHTML = `<li>No harvest data yet.</li>`;
    return;
  }

  const avgYield = (harvestLogs.reduce((sum, h) => sum + parseFloat(h.yield || 0), 0) / harvestLogs.length).toFixed(1);
  const flushCount = harvestLogs.length;

  summaryList.innerHTML = `
    <li><strong>Total Flushes:</strong> ${flushCount}</li>
    <li><strong>Average Yield:</strong> ${avgYield} g</li>
  `;
}
</script>
</body>
</html>
